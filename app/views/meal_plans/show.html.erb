<div class="meal-plan-container" 
     data-controller="meal-plan-show"
     data-meal-plan-show-meal-plan-id-value="<%= @meal_plan.id %>">
  
  <!-- Header -->
  <div class="meal-plan-header" data-meal-plan-show-target="header">
    <!-- Will be populated by JavaScript -->
    <div style="text-align: center; padding: 20px;">
      <p>Loading meal plan...</p>
    </div>
  </div>

  <!-- Error messages -->
  <div data-meal-plan-show-target="errors"></div>

  <div class="row">
    <!-- Left Column: Add Items Form -->
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header">
          <h4>Add Item to Plan</h4>
        </div>
        <div class="card-body">
          <form data-action="submit->meal-plan-show#addItem">
            <div class="form-group mb-3">
              <label for="scheduled_date">Date</label>
              <input 
                type="date" 
                id="scheduled_date"
                name="meal_plan_item[scheduled_date]"
                class="form-control" 
                min="<%= @meal_plan.start_date %>"
                max="<%= @meal_plan.end_date %>"
                value="<%= @meal_plan.start_date %>"
                required>
            </div>

            <div class="form-group mb-3">
              <label for="meal_slot">Meal Slot</label>
              <select 
                id="meal_slot"
                name="meal_plan_item[meal_slot]"
                class="form-control" 
                required>
                <option value="">Select meal slot</option>
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="snack">Snack</option>
              </select>
            </div>

            <!-- Radio buttons to choose Recipe or Item -->
            <div class="form-group mb-3">
              <label>Type</label>
              <div>
                <label class="radio-inline me-3">
                  <input 
                    type="radio" 
                    name="meal_plan_item[plannable_type]" 
                    value="Recipe"
                    checked
                    data-action="change->meal-plan-show#toggleType">
                  Recipe
                </label>
                <label class="radio-inline">
                  <input 
                    type="radio" 
                    name="meal_plan_item[plannable_type]" 
                    value="Item"
                    data-action="change->meal-plan-show#toggleType">
                  Item
                </label>
              </div>
              <small class="text-muted">Select a type to see options below</small>
            </div>

            <!-- Recipe Dropdown -->
            <div class="form-group mb-3" id="recipe-select">
              <label for="recipe_id">Select Recipe</label>
              <select 
                id="recipe_id"
                name="meal_plan_item[recipe_id]"
                class="form-control">
                <option value="">Choose a recipe</option>
                <% Recipe.all.each do |recipe| %>
                  <option value="<%= recipe.id %>"><%= recipe.title %></option>
                <% end %>
              </select>
            </div>

            <!-- Item Options -->
            <div id="item-select" style="display: none;">
              <div class="form-group mb-3">
                <label for="item_id">Select Existing Item</label>
                <select 
                  id="item_id"
                  name="meal_plan_item[item_id]"
                  class="form-control">
                  <option value="">Choose an item</option>
                  <% Item.all.each do |item| %>
                    <option value="<%= item.id %>"><%= item.item_name %></option>
                  <% end %>
                </select>
              </div>

              <div class="text-center my-2">
                <strong>OR</strong>
              </div>

              <div id="item-create">
                <div class="form-group mb-3">
                  <label for="new_item_name">Create New Item</label>
                  <input 
                    type="text" 
                    id="new_item_name"
                    name="new_item_name"
                    class="form-control" 
                    placeholder="Item name">
                </div>

                <div class="form-group mb-3">
                  <label for="new_item_quantity">Quantity (optional)</label>
                  <input 
                    type="text" 
                    id="new_item_quantity"
                    name="new_item_quantity"
                    class="form-control" 
                    placeholder="e.g., 2 lbs">
                </div>
              </div>
            </div>

            <button type="submit" class="btn btn-primary w-100">Add to Plan</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Right Column: Meal Plan Calendar View -->
    <div class="col-md-8">
      <div class="card mb-4" data-meal-plan-show-target="calendar">
        <!-- Calendar will be populated by JavaScript -->
      </div>

      <!-- Comments Section -->
      <div class="card">
        <div class="card-header">
          <h4>Comments</h4>
        </div>
        <div class="card-body">
          <!-- Add Comment Form -->
          <form data-action="submit->meal-plan-show#submitComment" data-meal-plan-show-target="commentForm">
            <div class="form-group mb-3">
              <textarea 
                class="form-control" 
                rows="3" 
                placeholder="Add a comment..."
                data-meal-plan-show-target="commentInput"
                required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
          </form>

          <!-- Display Comments -->
          <hr>
          <div class="comments-list" data-meal-plan-show-target="commentsList">
            <!-- Comments will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <%= link_to "â† Back to Meal Plans", meal_plans_path, class: "btn btn-secondary" %>
  </div>
</div>

<!-- Store current user ID for permission checks -->
<% if current_user %>
  <script>
    document.body.dataset.currentUserId = '<%= current_user.id %>';
  </script>
<% end %>