<div class="container">
  <div class="plan-header">
    <h1>ğŸ“‹ <%= @meal_plan.category %></h1>
    <div class="plan-meta">
      <div><strong>ğŸ“… Start Date:</strong> <%= @meal_plan.start_date.strftime("%B %d, %Y") %></div>
      <div><strong>ğŸ“… End Date:</strong> <%= @meal_plan.end_date.strftime("%B %d, %Y") %></div>
      <div><strong>ğŸ‘¤ Created by:</strong> <%= @meal_plan.user.email %></div>
      <div><strong>ğŸ“ Total Items:</strong> <%= @meal_plan.meal_plan_items.count %></div>
    </div>
    <%= link_to "â† Back to All Meal Plans", meal_plans_path, class: "back-link" %>
  </div>

  <% if notice %>
    <div class="flash-notice"><%= notice %></div>
  <% end %>

  <% if alert %>
    <div class="flash-alert"><%= alert %></div>
  <% end %>

  <div class="content-grid">
    <div class="main-content">
      <!-- Add Meal/Item Section --><div class="section">
  <h2>â• Add Meal or Item</h2>

  <%= form_with(model: [@meal_plan, @meal_plan_item], local: true) do |form| %>
    <%# 1. Date and Slot %>
    <div class="form-group">
      <%= form.label :scheduled_date %>
      <%= form.date_field :scheduled_date, class: "form-control", value: @meal_plan_item.scheduled_date || @meal_plan.start_date %>
    </div>

    <div class="form-group">
      <%= form.label :meal_slot %>
      <%= form.select :meal_slot, [['Breakfast', 'breakfast'], ['Lunch', 'lunch'], ['Dinner', 'dinner'], ['Snacks', 'snacks']], { prompt: "Select slot" }, class: "form-control" %>
    </div>

    <%# 2. Type Selector (Triggers the page refresh) %>
    <div class="form-group">
      <%= form.label :plannable_type, "What are you planning?" %>
      <%= form.select :plannable_type, [['Recipe', 'Recipe'], ['Item', 'Item']], { prompt: "Select type" }, class: "form-control", onchange: 'this.form.submit()' %>
    </div>

    <%# 3. Conditional Fields based on what the Controller sends back %>
    <% if @meal_plan_item.plannable_type == 'Recipe' %>
      <div class="form-group">
        <h4>Choose Recipe</h4>
        <%= form.collection_select :plannable_id, @recipes, :id, :title, { prompt: "Select a recipe" }, class: "form-control" %>
      </div>
    <% elsif @meal_plan_item.plannable_type == 'Item' %>
      <div class="form-group">
        <h4>Choose Existing Item</h4>
        <%= form.collection_select :plannable_id, @items, :id, :item_name, { prompt: "Select an item" }, class: "form-control" %>
      </div>

      <div class="new-item-section" style="border-top: 1px solid #eee; padding-top: 10px;">
        <h4>Or Create New Item</h4>
        <%= text_field_tag :new_item_name, nil, class: "form-control", placeholder: "New item name..." %>
        <%= text_field_tag :new_item_quantity, nil, class: "form-control", placeholder: "Quantity..." %>
      </div>
    <% end %>

    <%# 4. The Save Button %>
    <%= form.submit "Add to Plan", name: "commit", class: "btn btn-primary" %>
  <% end %>
</div>

      

    
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Comments Section -->
      <div class="section">
        <h2>ğŸ’¬ Comments (<%= @comments.count %>)</h2>

        <% if @comments.any? %>
          <% @comments.each do |comment| %>
            <div class="comment">
              <div class="comment-header">
                <span class="comment-author"><%= comment.user&.email || "Anonymous" %></span>
                <span class="comment-date">
                  <%= comment.created_at.strftime("%b %d, %I:%M %p") %>
                </span>
              </div>
              <div class="comment-body">
                <%= comment.content %>
              </div>
              <% if comment.user == current_user %>
                <%= button_to "Delete",
                    meal_plan_comment_path(@meal_plan, comment),
                    method: :delete,
                    class: "btn btn-danger",
                    form: { data: { turbo_confirm: "Delete this comment?" } } %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p style="color: #95a5a6; text-align: center; padding: 20px;">
            No comments yet. Be the first to comment!
          </p>
        <% end %>

        <div style="margin-top: 20px;">
          <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 16px;">
            Add Comment
          </h3>
          <%= form_with(model: [@meal_plan, @comment], local: true) do |form| %>
            <%= form.text_area :content,
                class: "form-control",
                placeholder: "Share your thoughts...",
                style: "margin-bottom: 10px;" %>
            <%= form.submit "Post Comment", class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>