<div class="container" data-controller="shopping-list-items" data-shopping-list-items-current-tab-value="<%= params[:add_tab] || 'select_item' %>">
  <h1>My Shopping List</h1>

  <!-- Success/Error Messages -->
  <div data-shopping-list-items-target="successMessage"></div>
  <div data-shopping-list-items-target="errors"></div>

  <!-- ADD ITEM FORM - Tab-Based Approach -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Add New Item</h5>
    </div>
    <div class="card-body">
      
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
          <a href="#" 
             class="nav-link <%= (params[:add_tab] == 'select_item' || params[:add_tab].blank?) ? 'active' : '' %>"
             data-action="click->shopping-list-items#switchTab"
             data-tab="select_item">
            Select Item
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#" 
             class="nav-link <%= params[:add_tab] == 'select_ingredient' ? 'active' : '' %>"
             data-action="click->shopping-list-items#switchTab"
             data-tab="select_ingredient">
            Select Ingredient
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a href="#" 
             class="nav-link <%= params[:add_tab] == 'manual' ? 'active' : '' %>"
             data-action="click->shopping-list-items#switchTab"
             data-tab="manual">
            Manual Entry
          </a>
        </li>
      </ul>

      <!-- Tab Content -->
      <% current_tab = params[:add_tab].presence || 'select_item' %>

      <!-- SELECT ITEM TAB -->
      <div id="select-item-tab" style="display: <%= current_tab == 'select_item' ? 'block' : 'none' %>;">
        <form class="row g-3" data-action="submit->shopping-list-items#addExistingItem">
          <div class="col-md-7">
            <label for="item_select" class="form-label">Select Item</label>
            <select id="item_select" 
                    class="form-select" 
                    data-shopping-list-items-target="itemSelect"
                    required>
              <option value="">Choose an item...</option>
              <% Item.all.each do |item| %>
                <option value="<%= item.id %>"><%= item.item_name %></option>
              <% end %>
            </select>
          </div>

          <div class="col-md-3">
            <label for="item_quantity" class="form-label">Quantity</label>
            <input type="text" 
                   id="item_quantity"
                   class="form-control" 
                   value="1"
                   data-shopping-list-items-target="itemQuantity"
                   required>
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add</button>
          </div>
        </form>
      </div>

      <!-- SELECT INGREDIENT TAB -->
      <div id="select-ingredient-tab" style="display: <%= current_tab == 'select_ingredient' ? 'block' : 'none' %>;">
        <form class="row g-3" data-action="submit->shopping-list-items#addExistingIngredient">
          <div class="col-md-7">
            <label for="ingredient_select" class="form-label">Select Ingredient</label>
            <select id="ingredient_select" 
                    class="form-select"
                    data-shopping-list-items-target="ingredientSelect"
                    required>
              <option value="">Choose an ingredient...</option>
              <% Ingredient.all.each do |ingredient| %>
                <option value="<%= ingredient.id %>"><%= ingredient.name %></option>
              <% end %>
            </select>
          </div>

          <div class="col-md-3">
            <label for="ingredient_quantity" class="form-label">Quantity</label>
            <input type="text" 
                   id="ingredient_quantity"
                   class="form-control" 
                   value="1"
                   data-shopping-list-items-target="ingredientQuantity"
                   required>
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add</button>
          </div>
        </form>
      </div>

      <!-- MANUAL ENTRY TAB -->
      <div id="manual-tab" style="display: <%= current_tab == 'manual' ? 'block' : 'none' %>;">
        <form class="row g-3" data-action="submit->shopping-list-items#addManualItem">
          <div class="col-md-4">
            <label for="manual_type" class="form-label">Type</label>
            <select id="manual_type" 
                    class="form-select"
                    data-shopping-list-items-target="manualType"
                    required>
              <option value="manual_item">Item</option>
              <option value="manual_ingredient">Ingredient</option>
            </select>
          </div>

          <div class="col-md-5">
            <label for="manual_name" class="form-label">Name</label>
            <input type="text" 
                   id="manual_name"
                   class="form-control" 
                   placeholder="Enter item or ingredient name"
                   data-shopping-list-items-target="manualName"
                   required>
          </div>

          <div class="col-md-2">
            <label for="manual_quantity" class="form-label">Quantity</label>
            <input type="text" 
                   id="manual_quantity"
                   class="form-control" 
                   value="1"
                   data-shopping-list-items-target="manualQuantity"
                   required>
          </div>

          <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add</button>
          </div>
        </form>
      </div>

    </div>
  </div>

  <!-- SHOPPING LIST TABLE -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Items to Purchase</h4>
      <div>
        <%= link_to "View Payments", payments_path, class: "btn btn-info btn-sm me-2" %>
        <button type="button"
                class="btn btn-warning btn-sm"
                data-action="click->shopping-list-items#clearPurchased">
          Clear Purchased Items
        </button>
      </div>
    </div>
    <div class="card-body">
      <table class="table table-striped">
        <thead>
          <tr>
            <th style="width: 50px;">Done</th>
            <th>Item</th>
            <th>Quantity</th>
            <th>Type</th>
            <th style="width: 250px;">Actions</th>
          </tr>
        </thead>
        <tbody data-shopping-list-items-target="tableBody">
          <!-- Items will be loaded here via JavaScript -->
          <tr>
            <td colspan="5" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="mt-3">
        <p class="text-muted">
          <strong>Total Items:</strong> <span data-shopping-list-items-target="totalItems">0</span> | 
          <strong>Purchased:</strong> <span data-shopping-list-items-target="purchasedCount">0</span> | 
          <strong>Remaining:</strong> <span data-shopping-list-items-target="remainingCount">0</span>
        </p>
      </div>

      <!-- Empty State -->
      <div data-shopping-list-items-target="emptyState" style="display: none;">
        <div class="text-center py-5">
          <p class="text-muted">Your shopping list is empty.</p>
          <p>Add items using the form above or from your meal plans!</p>
          <%= link_to "View Meal Plans", meal_plans_path, class: "btn btn-primary" %>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <%= link_to "â† Back to Meal Plans", meal_plans_path, class: "btn btn-secondary" %>
  </div>
</div>

<!-- Store current user ID -->
<% if current_user %>
  <script>
    document.body.dataset.currentUserId = '<%= current_user.id %>';
  </script>
<% end %>